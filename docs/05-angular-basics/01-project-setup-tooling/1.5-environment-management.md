# 1.5 Environment Management

**Branch: `1-5-environment-management`**

Angular supports multiple environments (development, staging, production) through configuration files and build-time replacements. This enables environment-specific API URLs, feature flags, and settings.

## Environment File Structure

```
src/environments/
├── environment.ts          # Development (default)
├── environment.prod.ts     # Production
├── environment.staging.ts  # Staging
└── environment.ci.ts       # CI/CD
```

**environment.ts (Development):**

```typescript
// src/environments/environment.ts
export const environment = {
  production: false,
  apiUrl: "http://localhost:3000/api",
  features: {
    analytics: true,
    debug: true,
  },
  logLevel: "debug",
};
```

**environment.prod.ts (Production):**

```typescript
// src/environments/environment.prod.ts
export const environment = {
  production: true,
  apiUrl: "https://api.myapp.com/api",
  features: {
    analytics: true,
    debug: false,
  },
  logLevel: "error",
};
```

## App Configuration Service

```typescript
// src/app/config/app-config.service.ts
import { inject } from "@angular/core";
import { ENVIRONMENT_CONFIG } from "./environment.token";

export class AppConfigService {
  private config = inject(ENVIRONMENT_CONFIG);

  get apiUrl() {
    return this.config.apiUrl;
  }

  get isProduction() {
    return this.config.production;
  }

  featureEnabled(feature: string) {
    return this.config.features?.[feature] ?? false;
  }
}
```

## Environment Token Provider

```typescript
// src/app/config/environment.token.ts
import { InjectionToken } from "@angular/core";
import { environment } from "../../environments/environment";

export const ENVIRONMENT_CONFIG = new InjectionToken("ENVIRONMENT_CONFIG");

export function provideEnvironmentConfig() {
  return {
    provide: ENVIRONMENT_CONFIG,
    useValue: environment,
  };
}
```

## Bootstrap with Environment Config

```typescript
// src/main.ts
import { bootstrapApplication } from "@angular/platform-browser";
import { AppComponent } from "./app/app.component";
import { provideRouter } from "@angular/router";
import { provideEnvironmentConfig } from "./app/config/environment.token";

bootstrapApplication(AppComponent, {
  providers: [
    provideRouter(appRoutes),
    provideEnvironmentConfig(), // ✅ Environment injection
  ],
});
```

## Angular.json Build Configurations

```json
{
  "projects": {
    "main-app": {
      "architect": {
        "build": {
          "configurations": {
            "production": {
              "fileReplacements": [
                {
                  "replace": "src/environments/environment.ts",
                  "with": "src/environments/environment.prod.ts"
                }
              ],
              "optimization": true
            },
            "staging": {
              "fileReplacements": [
                {
                  "replace": "src/environments/environment.ts",
                  "with": "src/environments/environment.staging.ts"
                }
              ]
            },
            "ci": {
              "fileReplacements": [
                {
                  "replace": "src/environments/environment.ts",
                  "with": "src/environments/environment.ci.ts"
                }
              ]
            }
          }
        }
      }
    }
  }
}
```

## Build Commands for Each Environment

```bash
# Development (default)
ng build
ng serve

# Production
ng build --configuration production

# Staging
ng build --configuration staging

# CI
ng build --configuration ci

# Custom environment
ng build --configuration=my-custom-env
```

## Runtime Environment Detection

```typescript
// src/app/services/logger.service.ts
import { AppConfigService } from "../config/app-config.service";

export class LoggerService {
  constructor(private config: AppConfigService) {}

  debug(message: string) {
    if (this.config.logLevel === "debug") {
      console.debug("[DEBUG]", message);
    }
  }

  error(message: string) {
    console.error("[ERROR]", message);
  }
}
```

## Advanced: Dynamic Environment Loading

**For server-side config (SSR/SSG):**

```typescript
// app.config.ts
import { mergeApplicationConfig, ApplicationConfig } from "@angular/core";
import { provideServerRendering } from "@angular/ssr/server-rendering";

const clientConfig: ApplicationConfig = {
  providers: [
    /* client providers */
  ],
};

const serverConfig: ApplicationConfig = {
  providers: [provideServerRendering()],
};

export const config = mergeApplicationConfig(clientConfig, serverConfig);
```

## Feature Flags Implementation

```typescript
// Feature flag service
@Injectable({ providedIn: "root" })
export class FeatureFlagService {
  constructor(private config: AppConfigService) {}

  analyticsEnabled = computed(() => this.config.featureEnabled("analytics"));
}
```

## Verification Checklist

**✅ Test each environment:**

```bash
# 1. Development
ng serve
# Check: apiUrl = http://localhost:3000/api, debug = true

# 2. Production build
ng build --configuration production
# Check: dist/main-app/main-es2015.js contains production config

# 3. Verify injection
# Console: AppConfigService.apiUrl should match environment
```

**Demo verification files:**

```
1-5-environment-management/
├── src/environments/
│   ├── environment.ts
│   ├── environment.prod.ts
│   └── environment.staging.ts
├── src/app/config/
│   ├── app-config.service.ts
│   └── environment.token.ts
└── angular.json  # Build configurations
```

**Package.json scripts:**

```json
{
  "scripts": {
    "build:prod": "ng build --configuration production",
    "build:staging": "ng build --configuration staging",
    "build:all": "ng build --configuration production && ng build --configuration staging"
  }
}
```

**✅ Complete when:**

- [ ] Multiple environment files created
- [ ] `AppConfigService` injects environment config
- [ ] `ng build --configuration production` uses prod config
- [ ] Feature flags toggle based on environment
- [ ] Runtime detection works (`isProduction`)

**Next: `1-6-linting-formatting-testing-setup.md`** - Quality pipeline setup!
